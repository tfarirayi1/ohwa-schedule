<!--
ohwa-schedule
An element that generates timetable information based on 5 minute slots
You supply: eventDuration, businessHours, bookedEvents to determine a possible start time
@tfarirayi1
-->
<link rel="import" href="bower_components/polymer/polymer.html">

<dom-module id="ohwa-schedule">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <template is="dom-repeat" items="{{_slotList}}">
      <h5>{{item}}</h5>
    </template>
  </template>

  <script>
    Polymer({

      is: 'ohwa-schedule',

      properties: {

        businessOpen: {
          type: String,
          value: '0930',
        },

        businessClose: {
          type: String,
          value: '1730'
        },

        _currentDate: {
          type: String
        },

        _currentEvents: {
          type: Array,
          computed: '_computeCurrentEvents(_currentDate)'
        },

        requiredEventMinutes: {
          type: Number,
          value: 45
        },

        requiredSlots: {
          type: Number,
          computed: '_computeRequiredSlots(requiredEventMinutes, _slotDuration)'
        },

        _slotDuration: {
          type: Number,
          value: 5
        },

        _totalSlots: {
          type: Number,
          computed: '_computeTotalSlots(businessClose, businessOpen, _slotDuration)'
        },

        _slotList: {
          type: Number,
          computed: '_computeSlotList(_totalSlots)'
        }

      },

      _computeSlotList: function() {
        var slotId = 0;
        var slotArray = [0];

        for (i=0; i < this._totalSlots; i++) {
          slotId += 5;
          slotArray.push(slotId);
        }
        // Ensure ascending order
        return slotArray.sort(function(a,b) {return a-b });
      },

      _computeTotalSlots: function(closeTime, openTime, slotDuration) {
        var timeA = moment(openTime, 'hhmm');
        var timeB = moment(closeTime, 'hhmm');
        // Number of minutes in the day divided by 5 i.e slot duration
        var timeBetween = timeB.diff(timeA, 'minutes');
        var _slots = timeBetween/5;
        var _overTime = 24; // Overtime slots

        return _slots + _overTime;
      },

      _computeCurrentEvents: function(selectedDate) {
        // Fetch events based on selected date

      },

      _computeRequiredSlots: function(eventDuration, slotDuration) {
        return eventDuration/slotDuration;
      },

      _slotToTime: function(slotId) {
        var openTime = moment(this.businessOpen, 'HH:mm'); // Convert time string to moment
        var resultTime = moment(openTime, 'HH:mm').add(slotId, 'minutes').format('HH:mm'); // Add the supplied number of minutes from origin

        return resultTime;
      },

      _findFreeSlots: function() {
        // code 
        var main = this;
         for (i=0; i < main._slotList.length; i++) {
          var slotLength = main.requiredSlots;
          var index1 = i;
          var index2 = i + slotLength;
          // time in minutes
          var a = main._slotList[index1];
          var b = main._slotList[index2];

          var _duration = main.requiredEventMinutes;

          var adjacent = function() {
            if ((b-a) != _duration) return false;
            return true;
            // console.log('Duration: ' + _duration + ' ' + main._slotToTime(a) + ' - ' + main._slotToTime(b));
          }
          var possibleStart = main._slotToTime(a);
          var beforeClose = moment(possibleStart, 'HH:mm').isSameOrBefore(moment(main.businessClose, 'HH:mm'));

          if(main._slotList.length > index2) {
            if (adjacent() && beforeClose) {
              var possibleStart = main._slotToTime(a);
              var finish = moment(possibleStart,'HH:mm').add(_duration, 'minutes').format('HH:mm');
              console.log(possibleStart + ' - ' + finish);
            }

          } 
        }
      },

      _removeEvents: function(eventList) {
        // Interpret the event start time and end time as slots
        // Splice the index of slots
        // Convert start time to slotId
        // Divide duration by 5 to get numSlots
        // splice on index of slotId and remove numSlots 
        // Events stored as events: { 27-JUN-17: [{start: '1030', duration: 60}], 28-JUN-17: [] }
        for (i = 0; i < eventList.length; i++) {
          var slotId = this._timeToSlot(eventList[i].start);
          var numSlots = this._durationToSlots(eventList[i].duration);
          
          var position = this._slotList.indexOf(slotId);
          // Remove events such that a new event can end at the start or start at the end, of the removed event
          this.splice('_slotList', position + 1, numSlots - 1); 
          console.log(this._slotToTime(slotId) + ' - ' + eventList[i].duration);
        }

      },

      _timeToSlot: function(time) {
        var eventStart = moment(time, 'hhmm');
        var openTime = moment(this.businessOpen, 'hhmm');
        // timeDiff equates to SlotID since SlotID equals number of minutes from start time
        return eventStart.diff(openTime, 'minutes');
      },

      _durationToSlots: function(minutes) {
        return (minutes/5);
      },

      ready: function() {
        this._removeEvents([
          {
            start: '1000',
            duration: 50
          },
          {
            start: '1135',
            duration: 45
          },
          {
            start: '1715',
            duration: 60
          }
        ]);

        this._findFreeSlots();
        console.log(this._slotToTime(50));
      }


    });
  </script>
</dom-module>
